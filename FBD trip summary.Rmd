---
title: "Fiordland Bottlenose Dolphin Monitoring"
output: pdf_document
---

```{r setup, include=FALSE}

library(rgdal);library(dplyr);library(ggplot2)

path<-"//storage.hcs-p01.otago.ac.nz/sci-marine-mammal-backup/Fiordland Bottlenose dolphin/Long Term Monitoring/Doubtful Sound Dolphin Monitoring/"
year<-2021
YYYY_MM<-'2021_05'

fullpath<-paste0(path,year,"/",YYYY_MM,"/")
```
```{r tracks, include=FALSE}

##TRACKS##
track_files<-list.files(paste0(fullpath,'Tracks'), pattern = "*.gpx", full.names = T)
track_filenames<-list.files(paste0(fullpath,'Tracks'), pattern = "*.gpx", full.names = F)
track_filenames<-stringr::str_replace(track_filenames,'.gpx','')
tracks<-sapply(track_files, function (x) rgdal::readOGR(x,"tracks"))
names(tracks)<-track_filenames

tracks<-do.call(rbind, tracks)
dates<-substr(tracks$datestamp,1,10)
library(ggplot2)

NZ <- raster::getData(country="New Zealand", level=1)

effort_map<-ggplot()+
  geom_polygon(NZ, mapping = aes(long,lat,group = group))+
  geom_path(tracks, mapping = aes(long,lat,group = group, color = group))+
  coord_sf(xlim = c(166.8,167.2), ylim = c(-45.5,-45.15), crs = 4269)+
  theme_bw()+
  scale_color_viridis_d(name = "Date",labels = dates)

ggsave(filename = 'effort_map.png',effort_map,device = 'png', './figures', dpi = 320)# width = 169, height = 60, units = "mm", dpi = 320)
  
```
```{r PA include= FALSE}

##Photo data##
data<-read.csv('./data/2021_05_Indbyday.csv', header = T, stringsAsFactors = F)
lifehist<-read.csv('./data/FBD_lifehistory.csv', header = T, stringsAsFactors = F)

photo_counts<-data%>%
  mutate(NAME = str_replace(NAME, "JOLLY", "JOLLY-GOOD"))%>%
  group_by(Date, NAME)%>%
  tally()

daily_cap<-photo_counts%>%
  mutate_if(is.numeric, ~1 * (. > 0))%>%
  left_join(lifehist, by = "NAME")%>%
  filter(NAME != "" & !grepl('_',NAME) & !grepl('CULL',NAME) & NAME != "UNMA" & !str_detect(NAME, "^UK") & !str_detect(NAME, "\\?"))%>%
  tidyr::pivot_wider(id_cols = c("NAME","SEX","BIRTH_YEAR","FIRST_YEAR"), names_from = "Date", values_from = "n")%>%
  arrange(NAME)%>%
  mutate(AgeClass = case_when(
    year - FIRST_YEAR > 3 ~ "A",
    year - BIRTH_YEAR == 0 ~ "C",
    !is.na(BIRTH_YEAR) & year - BIRTH_YEAR <= 3 & year - BIRTH_YEAR >= 0 ~ "J",
    TRUE ~ "U"
  ))

trip_cap<-daily_cap%>%
  distinct(NAME,SEX,AgeClass)

sex_prop<-trip_cap%>%
  group_by(SEX)%>%
  tally()%>%
  mutate(Proportion = round(n/sum(n),2))

age_prop<-trip_cap%>%
  group_by(AgeClass)%>%
  tally()%>%
  mutate(Proportion = round(n/sum(n),2))

```

```{r effort_map, , echo=FALSE, warning=FALSE, message=FALSE,out.width="100%",fig.align='left'}
knitr::include_graphics("./figures/effort_map.png")
```


